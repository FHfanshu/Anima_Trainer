# 从 ComfyUI 训练示例配置
# =======================
# 用法：
#   python train.py --config_file ./config/train_comfyui.yaml
# 说明：命令行里显式传入的参数会覆盖本文件里的同名项。

# =======================
# 模型来源
# =======================

# ComfyUI 路径（优先使用；从 ComfyUI/models 加载模型）
comfyui_path: "E:/AI/ComfyUI"  # 修改为你的 ComfyUI 路径；不使用则填 null

# 如果从 ComfyUI 加载失败，使用这个 HF 路径作为后备
pretrained_model_name_or_path: "circlestone-labs/Anima"

# 可选：指定模型 revision/variant（例如 variant: "fp16"）
revision: null
variant: null

# =======================
# LoRA / LyCORIS (LoKr)
# =======================

# lora_type:
# - "lora": 标准 PEFT LoRA（保存为 PEFT 格式目录）
# - "lokr": LyCORIS LoKr（需要安装 lycoris-lora；保存为 lycoris_weights.pt）
lora_type: "lokr"

# 通用低秩配置（lora / lokr 都会用到）
lora_rank: 32
lora_alpha: 32
lora_dropout: 0.0

# 目标模块：默认针对 Cosmos Transformer；一般保持默认即可
lora_target_modules:
  - "to_q"
  - "to_k"
  - "to_v"
  - "to_out.0"
  - "ff.net.0.proj"
  - "ff.net.2"
  - "proj_in"
  - "proj_out"

# LoKr 专用（仅 lora_type: "lokr" 时生效）
lokr_factor: 8
lokr_use_effective_conv2d: true

# =======================
# 数据集
# =======================

# 数据集根目录：默认读取“图片 + 同名 .txt/.caption 标签”
data_root: "E:/lora-scripts-v1.10.0/train/lance"

# 支持 repeats 目录命名（类似 kohya dreambooth）：
#   data_root/10_lance/xxx.png  -> 该子目录内样本重复 10 次
#   data_root/1_misc/xxx.png    -> 重复 1 次
# 子目录名不是“数字_开头”时默认按 1 次处理。

# ARB（按长宽比分桶训练 / aspect ratio bucketing）
# 开启后：DataLoader 会把相同 bucket 的样本组 batch，避免不同分辨率无法 stack。
enable_arb: true
min_bucket_reso: 512
max_bucket_reso: 1024
bucket_reso_steps: 64
bucket_no_upscale: false

# 训练图像分辨率（正方形）
resolution: 1024

# 数据增强
center_crop: true
random_flip: true

# 标签 dropout（0-1）：随机丢弃部分 tags 增强泛化
tag_dropout: 0.1

# 默认缓存 latent（更快；数据集很大时可设为 false）
cache_latents: true

# DataLoader worker 数
dataloader_num_workers: 4

# =======================
# 训练输出与基础参数
# =======================

output_dir: "./output/lance_lokr"
seed: 42

# 训练时长：
# - 只设置 num_train_epochs：按 epoch 训练
# - 或设置 max_train_steps：按步数训练（会自动反推 epoch）
num_train_epochs: 50
max_train_steps: null

train_batch_size: 4
gradient_accumulation_steps: 2
gradient_checkpointing: true

# =======================
# 优化器与学习率
# =======================

# optimizer:
# - "adamw8bit": 需要 bitsandbytes（Windows 可能不好装；不行就用 adamw）
# - "adamw": 标准 AdamW
optimizer: "adamw8bit"

learning_rate: 1.0e-4
scale_lr: true

# lr_scheduler: linear / cosine / cosine_with_restarts / polynomial / constant / constant_with_warmup
lr_scheduler: "cosine_with_restarts"
lr_warmup_steps: 0
lr_num_cycles: 1
lr_power: 1.0

adam_beta1: 0.9
adam_beta2: 0.999
adam_weight_decay: 0.01
adam_epsilon: 1.0e-8
max_grad_norm: 1.0

# =======================
# 精度 / 加速
# =======================

# mixed_precision: "no" / "fp16" / "bf16"
mixed_precision: "bf16"

# Flash Attention 2：Windows 下可能不可用；不可用会自动回退
enable_flash_attention: true

# =======================
# Checkpoint
# =======================

# 推荐：按 epoch 保存 checkpoint（更直观）
checkpointing_epochs: 5

# 兼容：按 step 保存 checkpoint（0 表示禁用）
checkpointing_steps: 0

# 保留最新 N 个 checkpoint（null 表示不限制）
checkpoints_total_limit: null

# 从指定 checkpoint 恢复（填路径或 null）
resume_from_checkpoint: null

# 是否保存完整训练状态（包括优化器状态）
save_state: true

# =======================
# Sample / 验证出图
# =======================

# 设置 validation_prompt 后，会在每隔 validation_epochs 的 epoch 生成样张
# 输出路径：output_dir/validation/
validation_prompt: male focus, solo, muscular male, 1boy, muscular, bara, pectorals, abs, male swimwear, furry, topless male, large pectorals, furry male, navel, stomach, tail, thighs, thick thighs, swim trunks, bulge, white background, shorts, no nipples, nipples, colored sclera, hand on hip, yellow sclera, feet out of frame, simple background, looking at viewer, cowboy shot, monster boy, black shorts, yellow eyes, blue fur, closed mouth, horns, digimon (creature)
validation_epochs: 10
num_validation_images: 4

# =======================
# 日志
# =======================

# report_to: wandb / tensorboard / all / none
report_to: "tensorboard"
wandb_project: "anima-lora-training"
wandb_entity: null
tracker_run_name: null

# Min-SNR 加权（扩散训练常用）
min_snr_gamma: 5.0
